<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Railway Traffic Control System</title>
<style>
/* === Base Styles === */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #0a1628 0%, #1a2744 50%, #0f1b2e 100%);
  color: #e2e8f0;
  min-height: 100vh;
  overflow-x: auto;
}
.header {
  text-align: center;
  padding: 2rem 1rem;
  background: linear-gradient(180deg, rgba(16, 185, 129, 0.1) 0%, transparent 100%);
  border-bottom: 1px solid rgba(16, 185, 129, 0.2);
}
.header h1 {
  font-size: 2.5rem;
  font-weight: 700;
  background: linear-gradient(135deg, #10b981, #34d399, #6ee7b7);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 0.5rem;
  text-shadow: 0 0 30px rgba(16, 185, 129, 0.3);
}
.header p {
  color: #94a3b8;
  font-size: 1.1rem;
  font-weight: 300;
}
.controls {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 1rem;
  padding: 1.5rem;
  flex-wrap: wrap;
}
.btn,
.publish-btn,
.help-btn {
  padding: 0.7rem 1.5rem;
  border: none;
  border-radius: 12px;
  background: rgba(30, 41, 59, 0.8);
  color: #e2e8f0;
  font-size: 0.9rem;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.3s, transform 0.3s, box-shadow 0.3s, border-color 0.3s;
  border: 1px solid rgba(16, 185, 129, 0.2);
  backdrop-filter: blur(10px);
}
.btn:hover,
.help-btn:hover {
  background: rgba(16, 185, 129, 0.2);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(16, 185, 129, 0.15);
  border-color: rgba(16, 185, 129, 0.4);
}
.btn.active {
  background: linear-gradient(135deg, #10b981, #059669);
  box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
}
.publish-btn {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white;
  font-weight: 600;
  box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
}
.publish-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
}
.mode-selector {
  display: flex;
  background: rgba(30, 41, 59, 0.6);
  border-radius: 15px;
  padding: 0.5rem;
  gap: 0.5rem;
  border: 1px solid rgba(16, 185, 129, 0.3);
}
.mode-btn {
  padding: 0.6rem 1.2rem;
  border: none;
  border-radius: 10px;
  background: transparent;
  color: #94a3b8;
  font-size: 0.9rem;
  cursor: pointer;
  transition: background 0.3s, color 0.3s, box-shadow 0.3s;
}
.mode-btn.active {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  box-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);
}
.dashboard {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr;
  grid-template-rows: auto auto;
  gap: 1.5rem;
  padding: 1.5rem;
  max-width: 1400px;
  margin: 0 auto;
}
.card {
  background: rgba(30, 41, 59, 0.4);
  border-radius: 16px;
  padding: 1.5rem;
  backdrop-filter: blur(20px);
  border: 1px solid rgba(71, 85, 105, 0.3);
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
  animation: slideInUp 0.6s ease-out;
}
.card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, #10b981, transparent);
  opacity: 0.6;
}
.card-header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 1.5rem;
}
.card-icon {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, #10b981, #059669);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}
.card-title {
  font-size: 1.4rem;
  font-weight: 600;
  color: #f8fafc;
  flex-grow: 1;
}
.trains-card {
  grid-row: span 2;
}
.train-list {
  max-height: 500px;
  min-height: 180px;
  overflow-y: auto;
  padding-right: 0.5rem;
  scroll-behavior: smooth;
  border: 1px solid rgba(16, 185, 129, 0.08);
}
.train-item {
  background: rgba(51, 65, 85, 0.4);
  border-radius: 12px;
  padding: 1rem;
  margin-bottom: 0.75rem;
  border-left: 3px solid #10b981;
  transition: all 0.3s;
  cursor: pointer;
  position: relative;
}
.train-item:hover {
  background: rgba(51, 65, 85, 0.6);
  transform: translateX(8px);
  box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
}
.train-item.conflict {
  border-left-color: #ef4444;
  background: rgba(239, 68, 68, 0.1);
}
.train-item.updated {
  border-left-color: #f59e0b;
  background: rgba(245, 158, 11, 0.1);
}
.train-item.paused {
  opacity: 0.6;
  border-left-color: #00f;
  background: rgba(59, 130, 246, 0.12);
}
.train-number {
  font-weight: 600;
  color: #10b981;
  font-size: 1.1rem;
  margin-bottom: 0.5rem;
}
.train-item.conflict .train-number {
  color: #ef4444;
}
.train-item.updated .train-number {
  color: #f59e0b;
}
.train-item.paused .train-number {
  color: #00f;
}
.train-details {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.5rem;
  font-size: 0.9rem;
  color: #cbd5e1;
}
.train-detail {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.status-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}
.status-item {
  text-align: center;
  padding: 1rem;
  background: rgba(51, 65, 85, 0.3);
  border-radius: 10px;
  transition: all 0.3s;
}
.status-item:hover {
  background: rgba(51, 65, 85, 0.5);
}
.status-value {
  font-size: 2rem;
  font-weight: 700;
  color: #10b981;
  display: block;
  margin-bottom: 0.25rem;
}
.status-label {
  font-size: 0.9rem;
  color: #94a3b8;
}
.alert-badge {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
  padding: 0.3rem 0.8rem;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
  margin-left: auto;
  box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
}
.alert-list {
  max-height: 220px;
  overflow-y: auto;
}
.alert-item {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  border-radius: 8px;
  padding: 0.75rem;
  margin-bottom: 0.5rem;
  color: #fca5a5;
  font-size: 0.9rem;
}
.alert-item.high {
  border-color: #ef4444;
  background: rgba(239, 68, 68, 0.2);
  color: #fecaca;
}
.ai-section {
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(52, 211, 153, 0.05));
  border: 1px solid rgba(16, 185, 129, 0.3);
}
.help-btn {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: white;
  border: none;
  padding: 0.7rem 1.5rem;
  border-radius: 10px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s;
  margin-bottom: 1rem;
  width: 100%;
}
.conflicts-info {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  border-radius: 8px;
  padding: 0.75rem;
  color: #fca5a5;
  text-align: center;
  font-weight: 500;
}
.kpi-list {
  list-style: none;
}
.kpi-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 0;
  border-bottom: 1px solid rgba(71, 85, 105, 0.3);
}
.kpi-item:last-child {
  border-bottom: none;
}
.kpi-value {
  font-weight: 600;
}
.kpi-positive {
  color: #10b981;
}
.kpi-negative {
  color: #ef4444;
}
@media (max-width: 1024px) {
  .dashboard {
    grid-template-columns: 1fr 1fr;
  }
  .trains-card {
    grid-column: span 2;
  }
}
@media (max-width: 768px) {
  .dashboard {
    grid-template-columns: 1fr;
    padding: 1rem;
  }
  .trains-card {
    grid-column: span 1;
  }
  .header h1 {
    font-size: 2rem;
  }
  .controls {
    padding: 1rem;
    flex-direction: column;
    align-items: stretch;
  }
  .mode-selector {
    order: -1;
    margin-bottom: 1rem;
  }
}
@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>
</head>
<body>
<header class="header">
  <h1>Railway Traffic Control System</h1>
  <p>Intelligent Decision Support for Section Controllers</p>
</header>
<div class="controls">
  <div class="mode-selector">
    <button class="mode-btn active" onclick="setMode('manual')">Manual</button>
    <button class="mode-btn" onclick="setMode('assist')">Assist</button>
    <button class="mode-btn" onclick="setMode('ai')">AI Controlled</button>
  </div>
  <button class="btn" onclick="toggleFilter()">üîç Filter</button>
  <button class="btn" onclick="toggleSearch()">üîç Search</button>
  <button class="btn" onclick="toggleAuto()">‚ö° Auto</button>
  <button class="btn" onclick="toggleSettings()">‚öôÔ∏è Settings</button>
  <button class="publish-btn" onclick="publishSchedule()">üì¢ Publish Schedule</button>
</div>
<main class="dashboard">
  <section class="card trains-card">
    <div class="card-header">
      <div class="card-icon">üöÑ</div>
      <h2 class="card-title">Active Trains</h2>
      <span id="train-count" class="alert-badge">14</span>
    </div>
    <div class="train-list" id="train-list"></div>
  </section>
  <section class="card" id="updated-trains-card">
    <div class="card-header">
      <div class="card-icon">‚úÖ</div>
      <h2 class="card-title">Updated Trains</h2>
    </div>
    <div class="train-list" id="updated-train-list"></div>
  </section>
  <section class="card">
    <div class="card-header">
      <div class="card-icon">üìä</div>
      <h2 class="card-title">Network Status</h2>
    </div>
    <div class="status-grid">
      <div class="status-item">
        <span class="status-value" id="total-trains">14</span>
        <span class="status-label">Total Trains</span>
      </div>
      <div class="status-item">
        <span class="status-value" id="on-time-percent">87%</span>
        <span class="status-label">On Time %</span>
      </div>
      <div class="status-item">
        <span class="status-value" id="avg-delay">3.2</span>
        <span class="status-label">Avg Delay (min)</span>
      </div>
      <div class="status-item">
        <span class="status-value" id="system-health">94%</span>
        <span class="status-label">System Health</span>
      </div>
    </div>
  </section>
  <section class="card">
    <div class="card-header">
      <div class="card-icon">‚ö†Ô∏è</div>
      <h2 class="card-title">System Alerts</h2>
      <div class="alert-badge" id="alert-count">0</div>
    </div>
    <div class="alert-list" id="alert-list"></div>
  </section>
  <section class="card ai-section">
    <div class="card-header">
      <div class="card-icon">ü§ñ</div>
      <h2 class="card-title">AI Decision Support</h2>
    </div>
    <button class="help-btn" onclick="getAIAssistance()">üîÑ Update Schedule</button>
    <div class="conflicts-info" id="conflicts-info">
      <strong id="conflict-count">0 conflicts detected</strong><br />
      Priority resolution recommended
    </div>
  </section>
  <section class="card">
    <div class="card-header">
      <div class="card-icon">üìà</div>
      <h2 class="card-title">Performance KPIs</h2>
    </div>
    <ul class="kpi-list">
      <li class="kpi-item">
        <span>System Efficiency</span>
        <span class="kpi-value kpi-positive">+1.2%</span>
      </li>
      <li class="kpi-item">
        <span>Track Utilization</span>
        <span class="kpi-value kpi-positive">+4.5%</span>
      </li>
      <li class="kpi-item">
        <span>Decision Accuracy</span>
        <span class="kpi-value kpi-positive">+6.1%</span>
      </li>
      <li class="kpi-item">
        <span>Avg Response Time</span>
        <span class="kpi-value kpi-negative">2.3s</span>
      </li>
    </ul>
  </section>
</main>
<script>
// === Constants & Variables ===
const TRAIN_FIELDS = { NAME: 0, ARRIVAL: 1, DEPARTURE: 2, TYPE: 3, PLATFORM: 4 };
let currentMode = "manual";
let trainData = {};
let conflicts = [];
let alerts = [];
let updatedTrains = new Set();
let updatedTrainSuggestions = [];

// Weather API Setup
const weatherApiKey = 'YOUR_OPENWEATHERMAP_API_KEY'; // Replace with your key
const stationWeather = {};
const stationToCity = {
  "1": "Delhi",
  "2": "Mumbai",
  "3": "Chennai",
  "4": "Kolkata"
};
const weatherDelayMap = {
  Clear: 0,
  Clouds: 1,
  Rain: 5,
  Thunderstorm: 10,
  Snow: 15,
  Mist: 3,
  Fog: 5,
  Drizzle: 3,
};

// --- Mode & Controls ---
function setMode(mode) {
  currentMode = mode;
  document.querySelectorAll(".mode-btn").forEach(btn => btn.classList.remove("active"));
  document.querySelector(`.mode-btn[onclick="setMode('${mode}')"]`).classList.add("active");
}
function toggleFilter() { alert("Filter action (not implemented)"); }
function toggleSearch() { alert("Search action (not implemented)"); }
function toggleAuto() { alert("Auto Mode (not implemented)"); }
function toggleSettings() { alert("Settings (not implemented)"); }
function publishSchedule() { alert("Schedule published!"); }
function showNotification(msg) { alert(msg); }

// --- Time Utilities ---
function timeToMinutes(timeStr) {
  const [hours, minutes] = timeStr.split(":").map(Number);
  return hours * 60 + minutes;
}
function minutesToTime(minutes) {
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return `${hours.toString().padStart(2, "0")}:${mins.toString().padStart(2, "0")}`;
}

// --- Weather Fetch & Delay Calculation ---
async function fetchWeatherForStations() {
  const cityNames = [...new Set(Object.values(stationToCity))];
  for (const city of cityNames) {
    try {
      const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${weatherApiKey}`);
      const data = await response.json();
      if (data.weather && data.weather.length > 0) {
        stationWeather[city] = data.weather[0].main;
      } else {
        stationWeather[city] = "Clear";
      }
    } catch (e) {
      console.error("Weather fetch error:", e);
      stationWeather[city] = "Clear";
    }
  }
  applyExpectedDelays();
}

function applyExpectedDelays() {
  Object.values(trainData).forEach(train => train.expectedDelay = 0);
  Object.entries(trainData).forEach(([id, train]) => {
    const city = stationToCity[train[TRAIN_FIELDS.PLATFORM]];
    const weatherCond = stationWeather[city] || "Clear";
    const delay = weatherDelayMap[weatherCond] || 0;
    train.expectedDelay = delay;
  });
  renderTrains();
}

// --- Core Train Logic ---
function initializeTrainData() {
  trainData = {
    1001: ["Rajdhani Express", "07:45", "08:00", "Special", "1"],
    1002: ["Shatabdi Express", "08:00", "08:10", "Special", "1"],
    1003: ["Garib Rath", "08:03", "08:10", "Normal", "1"],
    1004: ["Howra Chennai Mail", "08:04", "08:12", "Normal", "1"],
    1005: ["Mumbai Express", "08:20", "08:25", "Normal", "2"],
    1006: ["Kerala Express", "08:18", "08:30", "Special", "2"],
    1007: ["Tamil Nadu Express", "08:22", "08:28", "Normal", "2"],
    1008: ["Andhra Express", "08:35", "08:40", "Normal", "3"],
    1009: ["Karnataka Express", "08:38", "08:45", "Special", "3"],
    1010: ["Gujarat Mail", "08:50", "08:55", "Normal", "3"],
    1011: ["Punjab Mail", "08:52", "09:00", "Normal", "4"],
    1012: ["Assam Express", "09:05", "09:10", "Special", "4"],
    1013: ["Bengal Express", "09:08", "09:15", "Normal", "4"],
    1014: ["Northern Star", "09:20", "09:30", "Special", "1"],
    1015: ["Western Flyer", "09:35", "09:40", "Normal", "1"],
    1016: ["Eastern Comet", "09:42", "09:50", "Special", "2"],
    1017: ["Southern Breeze", "09:53", "10:00", "Normal", "2"],
    1018: ["Central Dash", "10:05", "10:12", "Special", "3"],
    1019: ["Sunrise Limited", "10:15", "10:20", "Normal", "3"],
    1020: ["Moonlight Express", "10:22", "10:30", "Special", "4"],
    1021: ["Hilltop Explorer", "10:35", "10:40", "Normal", "4"],
    1022: ["Coastal Cruiser", "10:42", "10:50", "Special", "1"],
    1023: ["Desert Star", "10:53", "11:00", "Normal", "1"],
    1024: ["River Runner", "11:05", "11:10", "Special", "2"],
  };
  checkStationTimeConflicts();
  populateAlerts();
  renderTrains();
  fetchWeatherForStations();
  updateStats();
}

function checkStationTimeConflicts() {
  conflicts = [];
  const trainNumbers = Object.keys(trainData);
  for (let i = 0; i < trainNumbers.length; i++) {
    const id1 = trainNumbers[i], info1 = trainData[id1];
    const arr1 = timeToMinutes(info1[TRAIN_FIELDS.ARRIVAL]);
    const dep1 = timeToMinutes(info1[TRAIN_FIELDS.DEPARTURE]);
    const plat1 = info1[TRAIN_FIELDS.PLATFORM];
    for (let j = i + 1; j < trainNumbers.length; j++) {
      const id2 = trainNumbers[j], info2 = trainData[id2];
      const arr2 = timeToMinutes(info2[TRAIN_FIELDS.ARRIVAL]);
      const dep2 = timeToMinutes(info2[TRAIN_FIELDS.DEPARTURE]);
      const plat2 = info2[TRAIN_FIELDS.PLATFORM];
      if (plat1 === plat2 && !(dep1 <= arr2 || dep2 <= arr1)) {
        conflicts.push([id1, id2, plat1]);
      }
    }
  }
  updateConflictDisplay();
  return conflicts.length > 0;
}

function updateConflictDisplay() {
  const conflictCount = conflicts.length;
  document.getElementById("conflict-count").innerText = 
    `${conflictCount} conflict${conflictCount !== 1 ? "s" : ""} detected`;
}

function resolveConflictsWithPriority() {
  const suggestions = [];
  for (const [id1, id2, platform] of conflicts) {
    const info1 = trainData[id1], info2 = trainData[id2];
    const arr1 = timeToMinutes(info1[TRAIN_FIELDS.ARRIVAL]);
    const dep1 = timeToMinutes(info1[TRAIN_FIELDS.DEPARTURE]);
    const arr2 = timeToMinutes(info2[TRAIN_FIELDS.ARRIVAL]);
    const dep2 = timeToMinutes(info2[TRAIN_FIELDS.DEPARTURE]);
    const priority1 = info1[TRAIN_FIELDS.TYPE] === "Special" ? 2 : 1;
    const priority2 = info2[TRAIN_FIELDS.TYPE] === "Special" ? 2 : 1;
    if (priority1 > priority2) {
      const newArrival = dep1 + 5;
      const timeDiff = newArrival - arr2;
      const newDeparture = dep2 + timeDiff;
      suggestions.push({
        trainId: id2, type: "time_change",
        oldArrival: info2[TRAIN_FIELDS.ARRIVAL], newArrival: minutesToTime(newArrival),
        oldDeparture: info2[TRAIN_FIELDS.DEPARTURE], newDeparture: minutesToTime(newDeparture),
        reason: `Delayed for high priority train ${id1}`
      });
    } else if (priority2 > priority1) {
      const newArrival = dep2 + 5;
      const timeDiff = newArrival - arr1;
      const newDeparture = dep1 + timeDiff;
      suggestions.push({
        trainId: id1, type: "time_change",
        oldArrival: info1[TRAIN_FIELDS.ARRIVAL], newArrival: minutesToTime(newArrival),
        oldDeparture: info1[TRAIN_FIELDS.DEPARTURE], newDeparture: minutesToTime(newDeparture),
        reason: `Delayed for high priority train ${id2}`
      });
    } else {
      if (canAssignToPlatform(id1, platform === "1" ? "2" : "1")) {
        suggestions.push({
          trainId: id1, type: "platform_change",
          oldPlatform: platform, newPlatform: platform === "1" ? "2" : "1",
          reason: `Conflict with train ${id2}`
        });
      } else if (canAssignToPlatform(id2, platform === "1" ? "2" : "1")) {
        suggestions.push({
          trainId: id2, type: "platform_change",
          oldPlatform: platform, newPlatform: platform === "1" ? "2" : "1",
          reason: `Conflict with train ${id1}`
        });
      } else {
        if (arr2 > arr1) {
          const newArrival = dep1 + 5;
          const timeDiff = newArrival - arr2;
          const newDeparture = dep2 + timeDiff;
          suggestions.push({
            trainId: id2, type: "time_change",
            oldArrival: info2[TRAIN_FIELDS.ARRIVAL], newArrival: minutesToTime(newArrival),
            oldDeparture: info2[TRAIN_FIELDS.DEPARTURE], newDeparture: minutesToTime(newDeparture),
            reason: `No platform available, delayed for ${id1}`
          });
        }
      }
    }
  }
  return suggestions;
}

function canAssignToPlatform(trainId, platform) {
  const trainInfo = trainData[trainId];
  const arr = timeToMinutes(trainInfo[TRAIN_FIELDS.ARRIVAL]);
  const dep = timeToMinutes(trainInfo[TRAIN_FIELDS.DEPARTURE]);
  for (const [id, info] of Object.entries(trainData)) {
    if (id === trainId || info[TRAIN_FIELDS.PLATFORM] !== platform) continue;
    const otherArr = timeToMinutes(info[TRAIN_FIELDS.ARRIVAL]);
    const otherDep = timeToMinutes(info[TRAIN_FIELDS.DEPARTURE]);
    if (!(dep <= otherArr || otherDep <= arr)) return false;
  }
  return true;
}

function applySuggestions(suggestions) {
  if (!suggestions.length) return;
  updatedTrains.clear();
  updatedTrainSuggestions = suggestions;
  for (const suggestion of suggestions) {
    const trainInfo = trainData[suggestion.trainId];
    if (suggestion.type === "platform_change") trainInfo[TRAIN_FIELDS.PLATFORM] = suggestion.newPlatform;
    else if (suggestion.type === "time_change") {
      trainInfo[TRAIN_FIELDS.ARRIVAL] = suggestion.newArrival;
      trainInfo[TRAIN_FIELDS.DEPARTURE] = suggestion.newDeparture;
    }
    updatedTrains.add(suggestion.trainId);
  }
  checkStationTimeConflicts();
  renderTrains();
  renderUpdatedTrains();
  updateStats();
  alerts = [];
  populateAlerts();
  showNotification("Schedule updated successfully!");
}

function getAIAssistance() {
  const suggestions = resolveConflictsWithPriority();
  if (!suggestions.length) showNotification("No conflicts detected.");
  else if (confirm(`AI Suggestions:\n${suggestions.map(s=>s.reason).join('\n')}\n\nAccept changes?`)) {
    applySuggestions(suggestions);
  }
}

// --- Render Functions ---
function renderTrains() {
  const trainList = document.getElementById("train-list");
  trainList.innerHTML = "";
  // Sort by train ID for stable display
  const sortedTrainIDs = Object.keys(trainData).sort((a,b) => parseInt(a) - parseInt(b));
  for (const id of sortedTrainIDs) {
    const info = trainData[id];
    let cls = "";
    if (conflicts.some(c => c.includes(id))) cls = "conflict";
    else if (updatedTrains.has(id)) cls = "updated";
    let paused = false;
    if (cls === "conflict") {
      const prioSelf = info[TRAIN_FIELDS.TYPE] === "Special" ? 2 : 1;
      conflicts.forEach(([cid1, cid2]) => {
        if (cid1 == id || cid2 == id) {
          const otherID = cid1==id ? cid2 : cid1;
          const prioOther = trainData[otherID][TRAIN_FIELDS.TYPE] === "Special" ? 2 : 1;
          if (prioSelf < prioOther) paused = true;
        }
      });
    }
    const classes = ["train-item"];
    if (cls) classes.push(cls);
    if (paused) classes.push("paused");
    trainList.innerHTML += `
      <div class="${classes.join(" ")}">
        <div class="train-number">${id} - ${info[TRAIN_FIELDS.NAME]}</div>
        <div class="train-details">
          <div class="train-detail">Arrival: ${info[TRAIN_FIELDS.ARRIVAL]}</div>
          <div class="train-detail">Departure: ${info[TRAIN_FIELDS.DEPARTURE]}</div>
          <div class="train-detail">Type: ${info[TRAIN_FIELDS.TYPE]}</div>
          <div class="train-detail">Platform: ${info[TRAIN_FIELDS.PLATFORM]}</div>
          <div class="train-detail">Expected Delay (min): <strong>${info.expectedDelay || 0}</strong></div>
        </div>
      </div>
    `;
  }
}

function renderUpdatedTrains() {
  const updatedTrainList = document.getElementById("updated-train-list");
  updatedTrainList.innerHTML = "";
  if (!updatedTrainSuggestions.length) {
    updatedTrainList.innerHTML = "<p style='text-align:center; color:#94a3b8; font-style:italic;'>No recent updates.</p>";
    return;
  }
  for (const sug of updatedTrainSuggestions) {
    const train = trainData[sug.trainId];
    let changeInfo = "";
    if (sug.type === "time_change") {
      changeInfo = `
        <div class="train-detail">
          <span>Arrival:</span>
          <span><span style="text-decoration:line-through; color:#ef4444;">${sug.oldArrival}</span> &rarr; ${sug.newArrival}</span>
        </div>
        <div class="train-detail">
          <span>Departure:</span>
          <span><span style="text-decoration:line-through; color:#ef4444;">${sug.oldDeparture}</span> &rarr; ${sug.newDeparture}</span>
        </div>`;
    } else if (sug.type === "platform_change") {
      changeInfo = `
        <div class="train-detail">
          <span>Platform:</span>
          <span><span style="text-decoration:line-through; color:#ef4444;">${sug.oldPlatform}</span> &rarr; ${sug.newPlatform}</span>
        </div>`;
    }
    updatedTrainList.innerHTML += `
      <div class="train-item updated">
        <div class="train-number">${sug.trainId} - ${train[TRAIN_FIELDS.NAME]}</div>
        <div class="train-details">
          ${changeInfo}
          <div class="train-detail" style="grid-column:span 2;">
            <span>Reason:</span>
            <span>${sug.reason}</span>
          </div>
        </div>
      </div>`;
  }
}

// --- Alerts & Stats ---
function populateAlerts() {
  alerts = [];
  for (const [id1, id2, platform] of conflicts) {
    alerts.push({
      type: "conflict",
      message: `Conflict: Train ${id1} and ${id2} on Platform ${platform}.`
    });
  }
  const alertCount = alerts.length;
  document.getElementById("alert-count").innerText = alertCount;
  const alertList = document.getElementById("alert-list");
  alertList.innerHTML = "";
  if (!alertCount) {
    alertList.innerHTML = "<p style='text-align:center; color:#94a3b8; font-style:italic;'>No active alerts.</p>";
    return;
  }
  for (const alert of alerts) {
    const div = document.createElement("div");
    div.className = "alert-item";
    div.innerText = alert.message;
    alertList.appendChild(div);
  }
}

function updateStats() {
  const totalTrains = Object.keys(trainData).length;
  const onTimeTrains = totalTrains - conflicts.length; // roughly
  const onTimePercent = Math.round((onTimeTrains / totalTrains) * 100);
  const avgDelay = conflicts.length > 0 ? (conflicts.length * 5) / totalTrains : 0; // dummy avg delay
  document.getElementById("total-trains").innerText = totalTrains;
  document.getElementById("train-count").innerText = totalTrains;
  document.getElementById("on-time-percent").innerText = `${onTimePercent}%`;
  document.getElementById("avg-delay").innerText = avgDelay.toFixed(1);
}

// --- Initialization ---
document.addEventListener("DOMContentLoaded", () => {
  initializeTrainData();
});
</script>
</body>
</html>